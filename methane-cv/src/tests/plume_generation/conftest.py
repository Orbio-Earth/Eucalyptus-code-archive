"""Fixtures for plume generation tests."""

from io import StringIO
from pathlib import Path

import pandas as pd
import pytest

from src.data.generation.plumes.gaussian_plume import GaussianPlume
from src.data.generation.plumes.generate import wind_direction


@pytest.fixture
def plume() -> GaussianPlume:
    return GaussianPlume(
        spatial_resolution=20.0,
        temporal_resolution=5.0,
        duration=300,
        crop_size=512,
        dispersion_coeff=2.0,
        emission_rate=1.0,
    )


@pytest.fixture
def wind_data_filepath(tmp_path: Path) -> Path:
    """Create wind data in temporary file with 300 seconds (5 minutes) of data."""
    data_io = StringIO("""
                timestamp   speed_x  speed_y  direction_deg
        2024-12-26T14:28:00 -2.973735 1.782069     -59.067024
        2024-12-26T14:28:05 -2.814748 2.297844     -50.773220
        2024-12-26T14:28:10 -2.899173 2.028730     -55.017147
        2024-12-26T14:28:15 -3.026608 2.275030     -53.068677
        2024-12-26T14:28:20 -2.962244 2.154915     -53.965597
        2024-12-26T14:28:25 -3.004830 2.190524     -53.907915
        2024-12-26T14:28:30 -3.412472 1.766363     -62.633022
        2024-12-26T14:28:35 -3.239720 2.129901     -56.677734
        2024-12-26T14:28:40 -2.910658 2.032665     -55.071385
        2024-12-26T14:28:45 -3.446095 2.208740     -57.342567
        2024-12-26T14:28:50 -2.625060 2.212812     -49.870561
        2024-12-26T14:28:55 -3.026076 1.943219     -57.293126
        2024-12-26T14:29:00 -2.879379 2.005375     -55.144296
        2024-12-26T14:29:05 -3.029976 1.594714     -62.241611
        2024-12-26T14:29:10 -2.590792 2.420740     -46.943423
        2024-12-26T14:29:15 -2.869476 2.152292     -53.127738
        2024-12-26T14:29:20 -2.794311 2.065134     -53.533767
        2024-12-26T14:29:25 -2.859272 1.643195     -60.114449
        2024-12-26T14:29:30 -2.891475 2.127457     -53.655526
        2024-12-26T14:29:35 -2.802921 1.982439     -54.729144
        2024-12-26T14:29:40 -2.775993 1.638114     -59.455137
        2024-12-26T14:29:45 -2.492819 1.658458     -56.364408
        2024-12-26T14:29:50 -2.843093 2.060706     -54.064975
        2024-12-26T14:29:55 -3.041784 2.114165     -55.199110
        2024-12-26T14:30:00 -3.062332 1.620465     -62.113977
        2024-12-26T14:30:05 -2.795244 1.612006     -60.028124
        2024-12-26T14:30:10 -2.597391 1.747285     -56.070973
        2024-12-26T14:30:15 -3.290928 2.259032     -55.532651
        2024-12-26T14:30:20 -2.995250 1.722760     -60.094037
        2024-12-26T14:30:25 -2.506938 1.976623     -51.745596
        2024-12-26T14:30:30 -2.589049 2.380193     -47.406711
        2024-12-26T14:30:35 -2.880801 1.916609     -56.364011
        2024-12-26T14:30:40 -2.865736 1.979812     -55.361097
        2024-12-26T14:30:45 -2.807227 1.767755     -57.800733
        2024-12-26T14:30:50 -2.890012 1.970073     -55.718398
        2024-12-26T14:30:55 -2.585181 1.957554     -52.866221
        2024-12-26T14:31:00 -2.989568 2.219459     -53.409761
        2024-12-26T14:31:05 -2.679309 1.640518     -58.521221
        2024-12-26T14:31:10 -3.125754 1.880689     -58.965716
        2024-12-26T14:31:15 -2.936713 2.232830     -52.753690
        2024-12-26T14:31:20 -2.516605 1.969550     -51.952491
        2024-12-26T14:31:25 -2.919060 2.248682     -52.391337
        2024-12-26T14:31:30 -3.015691 2.005435     -56.376087
        2024-12-26T14:31:35 -2.690311 1.791926     -56.333746
        2024-12-26T14:31:40 -2.628745 1.897798     -54.172949
        2024-12-26T14:31:45 -3.239403 1.811692     -60.783144
        2024-12-26T14:31:50 -2.998819 2.011130     -56.152587
        2024-12-26T14:31:55 -2.878885 1.853116     -57.230930
        2024-12-26T14:32:00 -2.993725 1.588989     -62.041835
        2024-12-26T14:32:05 -3.076765 1.472059     -64.431507
        2024-12-26T14:32:10 -2.665421 1.641921     -58.366593
        2024-12-26T14:32:15 -2.998049 1.914802     -57.434333
        2024-12-26T14:32:20 -2.322982 1.525342     -56.709856
        2024-12-26T14:32:25 -2.598269 1.515838     -59.740584
        2024-12-26T14:32:30 -2.385874 1.215177     -63.009276
        2024-12-26T14:32:35 -2.018699 1.119422     -60.990472
        2024-12-26T14:32:40 -2.763394 1.503227     -61.454759
        2024-12-26T14:32:45 -2.595406 1.928348     -53.388201
        2024-12-26T14:32:50 -2.345427 1.670503     -54.540074
        2024-12-26T14:32:55 -2.549917 1.784938     -55.008039
        2024-12-26T14:33:00 -2.565521 1.548142     -58.891473
        2024-12-26T14:33:05 -2.656537 1.509429     -60.395012
    """)

    filepath = tmp_path / "wind_data.parquet"
    (
        pd.read_csv(data_io, sep="\s+", header=0, index_col=False)
        .assign(
            timestamp=lambda df: pd.to_datetime(df.timestamp),
            speed_x=lambda df: df.speed_x.astype(float),
            speed_y=lambda df: df.speed_y.astype(float),
            direction_deg=lambda df: df.apply(lambda row: wind_direction(row.speed_x, row.speed_y), axis=1),
        )
        .to_parquet(filepath)
    )
    return filepath


@pytest.fixture
def wind_data_filepath_with_gaps(tmp_path: Path) -> Path:
    """Create wind data in temporary file with 300 seconds (5 minutes) of data."""
    data_io = StringIO("""
                timestamp   speed_x  speed_y  direction_deg
        2024-12-26T14:28:00 -2.973735 1.782069     -59.067024
        2024-12-26T14:28:05 -2.814748 2.297844     -50.773220
        2024-12-26T14:28:10 -2.899173 2.028730     -55.017147
        2024-12-26T14:28:15 -3.026608 2.275030     -53.068677
        2024-12-26T14:28:20 -2.962244 2.154915     -53.965597
        2024-12-26T14:28:25 -3.004830 2.190524     -53.907915
        2024-12-26T14:28:30 -3.412472 1.766363     -62.633022
        2024-12-26T14:28:35 -3.239720 2.129901     -56.677734
        2024-12-26T14:28:40 -2.910658 2.032665     -55.071385
        2024-12-26T14:28:45 -3.446095 2.208740     -57.342567
        2024-12-26T14:28:50 -2.625060 2.212812     -49.870561
        2024-12-26T14:29:00 -2.879379 2.005375     -55.144296
        2024-12-26T14:29:05 -3.029976 1.594714     -62.241611
        2024-12-26T14:29:10 -2.590792 2.420740     -46.943423
        2024-12-26T14:29:15 -2.869476 2.152292     -53.127738
        2024-12-26T14:29:20 -2.794311 2.065134     -53.533767
        2024-12-26T14:29:25 -2.859272 1.643195     -60.114449
        2024-12-26T14:29:30 -2.891475 2.127457     -53.655526
        2024-12-26T14:29:35 -2.802921 1.982439     -54.729144
        2024-12-26T14:29:40 -2.775993 1.638114     -59.455137
        2024-12-26T14:29:45 -2.492819 1.658458     -56.364408
        2024-12-26T14:29:50 -2.843093 2.060706     -54.064975
        2024-12-26T14:30:00 -3.062332 1.620465     -62.113977
        2024-12-26T14:30:05 -2.795244 1.612006     -60.028124
        2024-12-26T14:30:10 -2.597391 1.747285     -56.070973
        2024-12-26T14:30:15 -3.290928 2.259032     -55.532651
        2024-12-26T14:30:20 -2.995250 1.722760     -60.094037
        2024-12-26T14:30:25 -2.506938 1.976623     -51.745596
        2024-12-26T14:30:30 -2.589049 2.380193     -47.406711
        2024-12-26T14:30:35 -2.880801 1.916609     -56.364011
        2024-12-26T14:30:40 -2.865736 1.979812     -55.361097
        2024-12-26T14:30:45 -2.807227 1.767755     -57.800733
        2024-12-26T14:30:50 -2.890012 1.970073     -55.718398
        2024-12-26T14:31:00 -2.989568 2.219459     -53.409761
        2024-12-26T14:31:05 -2.679309 1.640518     -58.521221
        2024-12-26T14:31:10 -3.125754 1.880689     -58.965716
        2024-12-26T14:31:15 -2.936713 2.232830     -52.753690
        2024-12-26T14:31:20 -2.516605 1.969550     -51.952491
        2024-12-26T14:31:25 -2.919060 2.248682     -52.391337
        2024-12-26T14:31:30 -3.015691 2.005435     -56.376087
        2024-12-26T14:31:35 -2.690311 1.791926     -56.333746
        2024-12-26T14:31:40 -2.628745 1.897798     -54.172949
        2024-12-26T14:31:45 -3.239403 1.811692     -60.783144
        2024-12-26T14:31:50 -2.998819 2.011130     -56.152587
        2024-12-26T14:32:00 -2.993725 1.588989     -62.041835
        2024-12-26T14:32:05 -3.076765 1.472059     -64.431507
        2024-12-26T14:32:10 -2.665421 1.641921     -58.366593
        2024-12-26T14:32:15 -2.998049 1.914802     -57.434333
        2024-12-26T14:32:20 -2.322982 1.525342     -56.709856
        2024-12-26T14:32:25 -2.598269 1.515838     -59.740584
        2024-12-26T14:32:30 -2.385874 1.215177     -63.009276
        2024-12-26T14:32:35 -2.018699 1.119422     -60.990472
        2024-12-26T14:32:40 -2.763394 1.503227     -61.454759
        2024-12-26T14:32:45 -2.595406 1.928348     -53.388201
        2024-12-26T14:32:50 -2.345427 1.670503     -54.540074
        2024-12-26T14:33:00 -2.565521 1.548142     -58.891473
        2024-12-26T14:33:05 -2.656537 1.509429     -60.395012
    """)

    filepath = tmp_path / "wind_data.parquet"
    (
        pd.read_csv(data_io, sep="\s+", header=0, index_col=False)
        .assign(
            timestamp=lambda df: pd.to_datetime(df.timestamp),
            speed_x=lambda df: df.speed_x.astype(float),
            speed_y=lambda df: df.speed_y.astype(float),
            direction_deg=lambda df: df.apply(lambda row: wind_direction(row.speed_x, row.speed_y), axis=1),
        )
        .to_parquet(filepath)
    )
    return filepath


@pytest.fixture
def wind_df(wind_data_filepath: Path) -> pd.DataFrame:
    """Create a wind dataframe from the wind data file."""
    return pd.read_parquet(wind_data_filepath)


@pytest.fixture
def wind_with_gaps_df(wind_data_filepath_with_gaps: Path) -> pd.DataFrame:
    """Create a wind dataframe from the wind data file with gaps."""
    return pd.read_parquet(wind_data_filepath_with_gaps)
